# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this file,
# You can obtain one at http://mozilla.org/MPL/2.0/.

DEPTH     = ..
topsrcdir = @top_srcdir@
srcdir    = @srcdir@
VPATH     = @srcdir@

include $(topsrcdir)/config/config.mk

DIRS = $(NULL)

ifneq (,$(filter WINNT,$(OS_ARCH)))
DIRS += win
PARALLEL_DIRS += tools/redit
else
ifeq ($(OS_ARCH),Darwin)
DIRS += mac
endif # mac
endif # windows

EXTRA_PP_COMPONENTS = \
  WebappShellComponents.manifest \
  $(NULL)

EXTRA_JS_MODULES = \
	WebAppService.jsm \
	WindowsIconEmbeddingService.jsm \
	WindowsShortcutService.jsm \
	$(NULL)

include $(topsrcdir)/config/rules.mk

libs:: prefs.js
	$(NSINSTALL) -D $(DIST)/bin/defaults/pref/webapprt@mozilla.org
	$(INSTALL) $^ $(DIST)/bin/defaults/pref/webapprt@mozilla.org

# XXX Factor out with copies in browser/app/profile/extensions/webapprtext@mozilla.org/Makefile.in and config/Makefile.in.
ifdef LIBXUL_SDK
GRE_MILESTONE = $(shell $(PYTHON) $(topsrcdir)/config/printconfigsetting.py $(LIBXUL_DIST)/bin/platform.ini Build Milestone)
APP_INI_DEPS = $(LIBXUL_DIST)/bin/platform.ini
else
GRE_MILESTONE = $(shell tail -n 1 $(topsrcdir)/config/milestone.txt 2>/dev/null || tail -1 $(topsrcdir)/config/milestone.txt)
APP_INI_DEPS = $(topsrcdir)/config/milestone.txt
endif
APP_BUILDID := $(shell cat $(DEPTH)/config/buildid)
APP_INI_DEPS += $(DEPTH)/config/buildid
DEFINES += -DGRE_MILESTONE=$(GRE_MILESTONE) -DAPP_BUILDID=$(APP_BUILDID)

webapprt.ini: webapprt.ini.in $(APP_INI_DEPS)
	$(PYTHON) $(topsrcdir)/config/Preprocessor.py $(DEFINES) $< > $@

libs:: webapprt.ini
	$(INSTALL) webapprt.ini $(DIST)/bin

GARBAGE += webapprt.ini
